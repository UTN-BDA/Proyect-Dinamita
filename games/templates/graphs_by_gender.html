{% extends "base.html" %}
{% load static %}
{% block title %}
    Gr√°ficos por G√©nero
{% endblock title %}
{% block content %}
    <div class="container-fluid">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>üìä Cantidad de Juegos por G√©nero</h2>
            
            <!-- Panel de Control de √çndice -->
            {% if user.is_authenticated %}
            <div class="card border-primary" style="min-width: 350px;">
                <div class="card-header bg-primary text-white">
                    <h6 class="mb-0">üöÄ Optimizaci√≥n de Consulta</h6>
                </div>
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-8">
                            <small class="text-muted">Estado del √≠ndice:</small><br>
                            {% if index_exists %}
                                <span class="badge bg-success">‚úÖ Activo</span>
                                <small class="text-success d-block">Consulta optimizada</small>
                            {% else %}
                                <span class="badge bg-warning">‚ö†Ô∏è Sin √≠ndice</span>
                                <small class="text-warning d-block">Consulta est√°ndar</small>
                            {% endif %}
                        </div>
                        <div class="col-4">
                            <form method="post" class="d-inline">
                                {% csrf_token %}
                                {% if index_exists %}
                                    <button type="submit" name="index_action" value="drop" 
                                            class="btn btn-sm btn-outline-danger"
                                            onclick="return confirm('¬øEliminar el √≠ndice de optimizaci√≥n?')">
                                        üóëÔ∏è Eliminar
                                    </button>
                                {% else %}
                                    <button type="submit" name="index_action" value="create" 
                                            class="btn btn-sm btn-success">
                                        ‚ö° Crear
                                    </button>
                                {% endif %}
                            </form>
                        </div>
                    </div>
                    
                    <!-- Estad√≠sticas de rendimiento -->
                    <hr class="my-2">
                    <div class="row text-center">
                        <div class="col-4">
                            <small class="text-muted">Tiempo:</small><br>
                            <strong class="text-primary">{{ query_time }}ms</strong>
                        </div>
                        <div class="col-4">
                            <small class="text-muted">G√©neros:</small><br>
                            <strong class="text-info">{{ total_genres }}</strong>
                        </div>
                        <div class="col-4">
                            <small class="text-muted">Juegos:</small><br>
                            <strong class="text-success">{{ total_games }}</strong>
                        </div>
                    </div>
                    
                    <!-- Bot√≥n de Reporte de Rendimiento -->
                    <div class="mt-2">
                        <button type="button" class="btn btn-sm btn-outline-info w-100" 
                                onclick="generatePerformanceReport()" id="reportBtn">
                            üìà Generar Reporte de Rendimiento
                        </button>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Mensajes de estado -->
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}

        <!-- Modal para Reporte de Rendimiento -->
        <div class="modal fade" id="performanceModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-info text-white">
                        <h5 class="modal-title">üìä Reporte de Rendimiento - √çndices</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body" id="performanceContent">
                        <div class="text-center">
                            <div class="spinner-border text-info" role="status">
                                <span class="visually-hidden">Generando reporte...</span>
                            </div>
                            <p class="mt-2">Analizando rendimiento...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gr√°fico -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <canvas id="genreChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Informaci√≥n T√©cnica -->
        {% if user.is_authenticated %}
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">üîß Informaci√≥n T√©cnica</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Consulta Utilizada:</h6>
                                {% if index_exists %}
                                <code class="text-success">
                                    SELECT g.genre, COUNT(DISTINCT g.app_id)<br>
                                    FROM genres g WHERE g.genre IS NOT NULL<br>
                                    GROUP BY g.genre ORDER BY count DESC
                                </code>
                                <small class="text-success d-block mt-1">‚úÖ Con √≠ndice B-tree optimizado</small>
                                {% else %}
                                <code class="text-warning">
                                    Django ORM: Genres.objects.values("genre")<br>
                                    .annotate(count=Count("app", distinct=True))
                                </code>
                                <small class="text-warning d-block mt-1">‚ö†Ô∏è Sin optimizaci√≥n de √≠ndice</small>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <h6>Beneficios del √çndice:</h6>
                                <ul class="list-unstyled">
                                    <li>üöÄ <strong>Velocidad:</strong> Consultas hasta 10x m√°s r√°pidas</li>
                                    <li>üìä <strong>GROUP BY optimizado:</strong> Agrupaci√≥n eficiente</li>
                                    <li>üéØ <strong>Filtrado r√°pido:</strong> WHERE genre IS NOT NULL</li>
                                    <li>üíæ <strong>Ordenamiento:</strong> ORDER BY mejorado</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
    // Gr√°fico principal
    const ctx = document.getElementById('genreChart').getContext('2d');
    const genreChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: {{ labels|safe }},
            datasets: [{
                label: 'Cantidad de Juegos',
                data: {{ data|safe }},
                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { stepSize: 1 }
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: 'Distribuci√≥n de {{ total_genres }} G√©neros ({{ total_games }} juegos total) - {% if index_exists %}Optimizada{% else %}Est√°ndar{% endif %}'
                }
            }
        }
    });

    // Funci√≥n para generar reporte de rendimiento
    async function generatePerformanceReport() {
        const btn = document.getElementById('reportBtn');
        const modal = new bootstrap.Modal(document.getElementById('performanceModal'));
        const content = document.getElementById('performanceContent');
        
        btn.disabled = true;
        btn.innerHTML = '‚è≥ Generando...';
        modal.show();
        
        try {
            const response = await fetch('{% url "genre_performance_report" %}', {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                const improvement = data.improvement_percentage;
                const improvementColor = improvement > 0 ? 'success' : 'warning';
                
                content.innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>‚è±Ô∏è Tiempos de Respuesta</h6>
                            <div class="card bg-light">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <span>Sin √≠ndice:</span>
                                        <strong class="text-warning">${data.no_index_time} ms</strong>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span>Con √≠ndice:</span>
                                        <strong class="text-success">${data.with_index_time} ms</strong>
                                    </div>
                                    <hr>
                                    <div class="d-flex justify-content-between">
                                        <span>Mejora:</span>
                                        <strong class="text-${improvementColor}">${improvement.toFixed(1)}%</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>üìä Estad√≠sticas</h6>
                            <div class="card bg-light">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <span>Total g√©neros:</span>
                                        <strong>${data.total_genres}</strong>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span>Total juegos:</span>
                                        <strong>${data.total_games}</strong>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span>Tipo consulta:</span>
                                        <strong class="text-primary">GROUP BY + COUNT</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="alert alert-info mt-3">
                        <h6>üí° Recomendaci√≥n</h6>
                        ${improvement > 10 ? 
                            `<p>‚úÖ <strong>El √≠ndice mejora significativamente el rendimiento (${improvement.toFixed(1)}%)</strong>. Se recomienda mantenerlo activo para consultas frecuentes.</p>` :
                            `<p>‚ö†Ô∏è <strong>Mejora moderada (${improvement.toFixed(1)}%)</strong>. El beneficio del √≠ndice puede variar seg√∫n el volumen de datos.</p>`
                        }
                    </div>
                `;
            } else {
                content.innerHTML = '<div class="alert alert-danger">Error al generar el reporte</div>';
            }
        } catch (error) {
            content.innerHTML = '<div class="alert alert-danger">Error de conexi√≥n</div>';
        } finally {
            btn.disabled = false;
            btn.innerHTML = 'üìà Generar Reporte de Rendimiento';
        }
    }
    </script>
{% endblock content %}
